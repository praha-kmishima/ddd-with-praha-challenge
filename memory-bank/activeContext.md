# アクティブコンテキスト

## 現在の開発フェーズ

プロジェクトは初期段階にあり、基本的なTODOリスト機能が実装済みです。現在はプラハチャレンジの仕様に記載されている参加者、チーム、課題の管理機能の実装を進めています。

## 現在の焦点

### 実装済みの機能
- 基本的なタスク管理機能（作成、編集、完了状態変更、取得）
- 値オブジェクト（Result型、EmailAddress、EnrollmentStatus、TeamName、ProgressStatus）
- チーム集約（TeamMember、Team、TeamRepository）
- 課題集約の拡張（所有者と進捗ステータスの追加）

### 現在取り組んでいる課題
- ドメインイベント基盤の実装

## 最近の変更点

### アーキテクチャの決定
- オニオンアーキテクチャの採用
- 2つの集約（チーム、課題）によるドメインモデルの設計
- ドメインイベントを用いた集約間連携の方針決定
- ドメインサービスを最小限に抑えるアプローチの採用

### 技術スタックの選定
- TypeScriptとNode.js、Honoフレームワーク
- DrizzleによるPostgreSQLアクセス
- Vitestによるテスト環境

### 実装の進捗
- 値オブジェクトの実装パターンの確立（不変性、ファクトリメソッド、等価性比較）
- Taskエンティティの拡張（所有者ID、進捗ステータス、進捗ステータス変更ロジック）
- タスクリポジトリの拡張（Result型によるエラーハンドリング、所有者IDによる検索機能）

## 次のステップ

### 短期的な目標
1. **ドメインイベント基盤の実装（フェーズ別アプローチ）**
   - フェーズ1: 基本実装（ドメインイベント基底クラス、イベントバス）
   - フェーズ2: チーム集約の基本イベント（チーム作成、メンバー追加）
   - フェーズ3: 課題集約のイベント（課題進捗更新）
   - フェーズ4: 追加のチームイベント（メンバー削除、状態変更）
   - フェーズ5: チームサイズ関連イベント（過小サイズ、過大サイズ）
   - フェーズ6: 基本的なイベントハンドラー実装

2. **アプリケーション層のポリシー実装**
   - TeamReorganizationPolicyの実装
   - TaskManagementPolicyの実装

3. **ユースケースの更新**
   - 既存のタスク関連ユースケースの更新
   - 新しい課題関連ユースケースの実装

### 中期的な目標
- チーム再編サービスの実装
- 複雑なビジネスルールの実装（チーム再編ロジック、メール通知機能）
- クエリ最適化

## 現在のアクティブな決定事項

### 設計上の決定
1. **集約の設計方針**
   - チーム集約と課題集約の2つの集約に分割
   - チーム集約内に参加者を子エンティティとして含める
   - 集約間の参照はIDのみを使用

2. **値オブジェクトの実装方針**
   - 不変性を持つクラスとして実装
   - ファクトリメソッドでバリデーションを行い、Result型で結果を返す
   - 等価性比較のためのequalsメソッドを実装

3. **リポジトリの実装方針**
   - インターフェースをドメイン層で定義、実装はインフラストラクチャ層で提供
   - トランザクション管理を考慮した設計
   - モックリポジトリを使用したテスト実装

4. **ドメインイベントの実装方針**
   - ドメインイベント基盤を `domain/event` フォルダに配置
   - 各集約に関連するイベントは、それぞれの集約のフォルダ内の `events` サブフォルダに配置
   - イベントハンドラーはアプリケーション層に配置
   - 段階的な実装アプローチを採用（フェーズ別）

### 技術的な決定
- Result型を用いたエラーハンドリング
- ドメイン層は単体テストで高いカバレッジを確保
- 集約のサイズを適切に保つ
- イベント処理の非同期化

## 現在の課題と懸念事項

1. **Nominal Typing**
   - TypeScriptの構造的型システムでは、同じプロパティを持つ型が等価になってしまう
   - ブランド型や独自の型ガードを使用した名目的型付けの実装方法の検討

2. **集約サイズとクエリ最適化**
   - チーム集約が大きくなる可能性がある
   - 参加者単独の情報を取得するクエリが複雑になる可能性
   - クエリサービスを活用して読み取り操作を最適化する必要がある

3. **イベント処理の信頼性**
   - イベント処理中のエラーハンドリング
   - 結果整合性（Eventually Consistent）の実現方法
   - イベントの永続化と再処理の仕組み

4. **既存ユースケースの更新**
   - Taskエンティティの拡張に伴い、既存のユースケースを更新する必要がある
   - タスク完了状態変更ユースケースは進捗ステータス更新ユースケースに置き換える必要がある
