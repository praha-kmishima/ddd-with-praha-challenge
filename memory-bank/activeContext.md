# アクティブコンテキスト

## 現在の開発フェーズ

現在、プロジェクトは初期段階にあります。基本的なTODOリスト機能が実装されていますが、プラハチャレンジの仕様に記載されている参加者、チーム、課題の管理機能の実装を進めています。

## 現在の焦点

### 実装済みの機能
- 基本的なタスク管理機能
  - タスクの作成
  - タスクのタイトル編集
  - タスクの完了状態への変更
  - タスクの取得
  - タスクリストの取得
- 値オブジェクトの基盤
  - Result型の実装（成功/失敗を表現する型）
  - EmailAddress値オブジェクトの実装
  - EnrollmentStatus値オブジェクトの実装
  - TeamName値オブジェクトの実装
  - ProgressStatus値オブジェクトの実装
- チーム集約の実装
  - TeamMemberエンティティの実装
  - Teamエンティティの実装
  - TeamRepositoryインターフェースの定義
  - PostgresqlTeamRepositoryの実装
  - チームリポジトリのテスト実装
- 課題集約の拡張
  - Taskエンティティの拡張（所有者と進捗ステータスの追加）
  - 進捗ステータス変更ロジックの実装（所有者チェックと状態遷移チェック）
  - タスクリポジトリの拡張（所有者による検索機能の追加）
  - タスクリポジトリのテスト実装

### 現在取り組んでいる課題
- ドメインイベント基盤の実装

## 最近の変更点

### アーキテクチャの決定
- オニオンアーキテクチャの採用
- 2つの集約（チーム、課題）によるドメインモデルの設計
- ドメインイベントを用いた集約間連携の方針決定
- ドメインサービスを最小限に抑えるアプローチの採用

### 技術スタックの選定
- TypeScriptとNode.jsによる実装
- Honoフレームワークを用いたAPIサーバーの構築
- DrizzleによるPostgreSQLアクセスの実装
- Vitestによるテスト環境の整備

### 実装の進捗
- 値オブジェクトの実装方針の確立
  - 不変性を持つクラスとして実装
  - ファクトリメソッドでバリデーションを行い、Result型で結果を返す
  - 等価性比較のためのequalsメソッドを実装
- EmailAddress値オブジェクトの実装完了
  - バリデーションロジックの実装
  - テストケースの作成と実行
- EnrollmentStatus値オブジェクトの実装完了
  - 在籍状態の値と遷移ルールの管理
  - チーム所属可能性の判定
  - テストケースの作成と実行
- TeamName値オブジェクトの実装完了
  - チーム名のバリデーション（英文字のみ）
  - 等価性比較の実装
  - テストケースの作成と実行
- ProgressStatus値オブジェクトの実装完了
  - 進捗状態の値と遷移ルールの管理
  - 状態遷移の可否判定の実装
  - テストケースの作成と実行
- Taskエンティティの拡張完了
  - 所有者ID（ownerId）の追加
  - 進捗ステータス（progressStatus）の追加
  - 進捗ステータス変更メソッド（changeProgressStatus）の実装
  - 所有者チェックと状態遷移チェックの実装
  - テストケースの更新と実行
- タスクリポジトリの拡張完了
  - Result型を使用したエラーハンドリングの導入
  - 所有者IDによるタスク検索機能（findByOwnerId）の追加
  - PostgreSQLリポジトリ実装の更新
  - モックリポジトリを使用したテスト実装

## 次のステップ

### 短期的な目標
1. **ドメインイベント基盤の実装**
   - イベント発行の仕組み構築
   - イベントハンドラーの実装
   - イベント購読の仕組み構築

2. **アプリケーション層のポリシー実装**
   - TeamReorganizationPolicyの実装
   - TaskManagementPolicyの実装

3. **ユースケースの更新**
   - 既存のタスク関連ユースケースの更新
   - 新しい課題関連ユースケースの実装（課題割り当て、進捗ステータス更新）

### 中期的な目標
1. **最小限のドメインサービスの実装**
   - チーム再編サービスの実装（複雑なアルゴリズムのみ）

2. **複雑なビジネスルールの実装**
   - 参加者の増減に伴うチーム再編ロジック
   - メール通知機能の実装
   - 課題の進捗管理ロジック

3. **クエリ最適化**
   - 読み取り操作のためのクエリサービスの実装
   - パフォーマンス改善

## 現在のアクティブな決定事項

### 設計上の決定
1. **集約の設計方針**
   - チーム集約と課題集約の2つの集約に分割
   - チーム集約内に参加者を子エンティティとして含める
   - 集約間の参照はIDのみを使用

2. **値オブジェクトの実装方針**
   - 不変性を持つクラスとして実装
   - ファクトリメソッドでバリデーションを行い、Result型で結果を返す
   - 等価性比較のためのequalsメソッドを実装
   - 状態遷移ルールを持つ値オブジェクトはcanTransitionToメソッドを実装

3. **リポジトリの実装方針**
   - インターフェースをドメイン層で定義
   - 実装はインフラストラクチャ層で提供
   - トランザクション管理を考慮した設計
   - モックリポジトリを使用したテスト実装

4. **ドメインイベントの活用**
   - 集約間の連携にドメインイベントを使用
   - イベント駆動アーキテクチャの採用
   - アプリケーション層のポリシーでイベントを購読

### 技術的な決定
1. **型安全性の確保**
   - Result型を用いたエラーハンドリング
   - Zodによる入力バリデーション

2. **テスト戦略**
   - ドメイン層は単体テストで高いカバレッジを確保
   - リポジトリはモックを用いたテストで検証
   - ユースケースはモックを用いたテストで検証
   - E2Eテストでシナリオベースの検証

3. **パフォーマンス考慮事項**
   - 集約のサイズを適切に保つ
   - 必要に応じてクエリサービスを用いた読み取り最適化
   - イベント処理の非同期化

## 現在の課題と懸念事項

1. **Value Objectの実装**
   - EmailAddress、EnrollmentStatus、TeamName、ProgressStatus値オブジェクトの実装は完了
   - 基本的な値オブジェクトの実装パターンが確立

2. **Nominal Typing**
   - TypeScriptの構造的型システムでは、同じプロパティを持つ型が等価になってしまう
   - ブランド型や独自の型ガードを使用した名目的型付けの実装方法の検討

3. **集約サイズの考慮**
   - チーム集約が大きくなる可能性がある
   - パフォーマンスへの影響を考慮する必要がある

4. **クエリ最適化の必要性**
   - 参加者単独の情報を取得するクエリが複雑になる可能性
   - クエリサービスを活用して読み取り操作を最適化する必要がある

5. **イベント処理の信頼性**
   - イベント処理中の障害対応
   - 結果整合性（Eventually Consistent）の実現方法
   - イベントの永続化と再処理の仕組み

6. **既存ユースケースの更新**
   - Taskエンティティの拡張に伴い、既存のユースケースを更新する必要がある
   - 特に、タスク完了状態変更ユースケースは進捗ステータス更新ユースケースに置き換える必要がある
