# アクティブコンテキスト

## 現在の開発フェーズ

プロジェクトはマイルストーン 6 まで完了し、基本的な TODO リスト機能に加えて、チーム管理と課題管理の基本機能が実装されています。ドメインイベント基盤の実装も完了し、チーム再編成ポリシーも実装されています。

## 現在の焦点

### 実装済みの機能

- 基本的なタスク管理機能（作成、編集、完了状態変更、取得）
- 値オブジェクト（Result 型、EmailAddress、EnrollmentStatus、TeamName、ProgressStatus）
- チーム集約（TeamMember、Team、TeamRepository）
- 課題集約の拡張（所有者と進捗ステータスの追加）
- ドメインイベント基盤の実装（イベントバス、各種イベント）
- アプリケーション層のポリシー（TeamReorganizationPolicy）

### 現在取り組んでいる課題

- チーム再編成サービスの実装

## 最近の変更点

### ドメインイベント基盤の実装

- ドメインイベント基底クラスの実装
- イベントバスの実装と静的ファサードの提供
- 各集約からのイベント発行機能の追加

### チーム集約の拡張

- チーム作成、メンバー追加/削除、状態変更などのイベント発行
- チームサイズ関連イベント（過小サイズ、過大サイズ）の実装
- チーム再編成のためのインターフェース定義

### 課題集約の拡張

- 課題作成、進捗更新イベントの実装
- 進捗ステータス変更ロジックの強化

### アプリケーション層のポリシー実装

- TeamReorganizationPolicy の実装
- チームサイズの変更に応じたチーム再編処理の調整機能

## 次のステップ

### 短期的な目標

1. **チーム再編成サービスの実装**

   - TeamReorganizationService の具体的な実装
   - チーム統合アルゴリズムの実装
   - チーム分割アルゴリズムの実装

2. **TaskManagementPolicy の実装**

   - 参加者の状態変更に伴う課題の処理
   - MemberStatusChangedEvent、MemberRemovedEvent の購読

3. **ユースケースの更新と拡張**
   - 既存のタスク関連ユースケースの更新
   - チーム関連のユースケースの実装
   - 課題関連の新しいユースケースの実装

### 中期的な目標

- API エンドポイントの実装
- 複雑なビジネスルールの実装（メール通知機能など）
- クエリ最適化とパフォーマンス改善

## 現在のアクティブな決定事項

### 設計上の決定

1. **集約の設計方針**

   - チーム集約と課題集約の 2 つの集約に分割
   - チーム集約内に参加者を子エンティティとして含める
   - 集約間の参照は ID のみを使用

2. **値オブジェクトの実装方針**

   - 不変性を持つクラスとして実装
   - ファクトリメソッドでバリデーションを行い、Result 型で結果を返す
   - 等価性比較のための equals メソッドを実装

3. **リポジトリの実装方針**

   - インターフェースをドメイン層で定義、実装はインフラストラクチャ層で提供
   - トランザクション管理を考慮した設計
   - モックリポジトリを使用したテスト実装

4. **ドメインイベントの実装方針**
   - ドメインイベント基盤を `domain/event` フォルダに配置
   - 各集約に関連するイベントは、それぞれの集約のフォルダ内の `events` サブフォルダに配置
   - イベントハンドラーはアプリケーション層に配置
   - 同期的なイベント処理を採用（現在のプロジェクト規模では十分）

### 技術的な決定

- Result 型を用いたエラーハンドリング
- ドメイン層は単体テストで高いカバレッジを確保
- 集約のサイズを適切に保つ
- 同期的なイベント処理を採用（シンプルさと即時整合性を重視）

## 現在の課題と懸念事項

1. **Nominal Typing**

   - TypeScript の構造的型システムでは、同じプロパティを持つ型が等価になってしまう
   - ブランド型や独自の型ガードを使用した名目的型付けの実装方法の検討

2. **集約サイズとクエリ最適化**

   - チーム集約が大きくなる可能性がある
   - 参加者単独の情報を取得するクエリが複雑になる可能性
   - クエリサービスを活用して読み取り操作を最適化する必要がある

3. **イベント処理のエラーハンドリング**

   - イベントハンドラ内でのエラーが、元の操作に影響しないようにする
   - エラーが発生した場合の適切なログ記録と通知

4. **既存ユースケースの更新**

   - Task エンティティの拡張に伴い、既存のユースケースを更新する必要がある
   - タスク完了状態変更ユースケースは進捗ステータス更新ユースケースに置き換える必要がある

5. **TeamReorganizationService の実装**
   - 複雑なチーム統合・分割アルゴリズムの実装
   - エッジケースの適切な処理
