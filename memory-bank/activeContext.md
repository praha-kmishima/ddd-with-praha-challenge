# アクティブコンテキスト

## 現在の開発フェーズ

プロジェクトはマイルストーン 5 まで完了し、基本的な TODO リスト機能に加えて、チーム管理と課題管理の基本機能が実装されています。ドメインイベント基盤の実装も完了し、チーム再編成ポリシーとチーム再編成サービスも実装されています。

## 現在の焦点

### 実装済みの機能

- 基本的なタスク管理機能（作成、編集、完了状態変更、取得）
- 値オブジェクト（Result 型、EmailAddress、EnrollmentStatus、TeamName、ProgressStatus）
- チーム集約（TeamMember、Team、TeamRepository）
- 課題集約の拡張（所有者と進捗ステータスの追加）
- ドメインイベント基盤の実装（イベントバス、各種イベント）
- アプリケーション層のポリシー（TeamReorganizationPolicy）
- ドメインサービス（TeamReorganizationServiceImpl）

### 現在取り組んでいる課題

- ユースケースの更新と拡張
- UpdateTaskProgressUseCaseの実装とコントローラー設計
- チーム関連のユースケース実装

## 最近の変更点

### ドメインイベント基盤の実装

- ドメインイベント基底クラスの実装
- イベントバスの実装と静的ファサードの提供
- 各集約からのイベント発行機能の追加

### チーム集約の拡張

- チーム作成、メンバー追加/削除、状態変更などのイベント発行
- チームサイズ関連イベント（過小サイズ、過大サイズ）の実装
- チーム再編成のためのインターフェース定義と実装

### 課題集約の拡張

- 課題作成、進捗更新イベントの実装
- 進捗ステータス変更ロジックの強化

### アプリケーション層のポリシー実装

- TeamReorganizationPolicy の実装
- チームサイズの変更に応じたチーム再編処理の調整機能

### ドメインサービスの実装

- TeamReorganizationServiceImpl の実装
- チーム統合アルゴリズムの実装
- チーム分割アルゴリズムの実装

### UpdateTaskProgressUseCaseの実装

- SetTaskDoneUseCaseを置き換える汎用的な進捗ステータス更新ユースケースの実装
- 任意の進捗ステータスに更新できる機能の実装
- 進捗ステータスの遷移ルールに従った状態変更の実装
- エラーハンドリングの強化（タスク未検出、無効な進捗ステータス、不正な状態遷移など）
- テストの実装（正常系・異常系）

### CreateTeamUseCaseの実装

- チーム名のバリデーション
- チーム名の一意性確認
- チームエンティティの作成と永続化
- エラーハンドリングの実装（無効なチーム名、既存チーム名、保存エラーなど）
- テストの実装（正常系・異常系）

## 次のステップ

### 短期的な目標

1. **ユースケースの更新と拡張**
   - 既存のタスク関連ユースケースの更新
   - チーム関連のユースケースの実装
   - 課題関連の新しいユースケースの実装

### 中期的な目標

- API エンドポイントの実装
- 複雑なビジネスルールの実装（メール通知機能など）
- クエリ最適化とパフォーマンス改善

## 現在のアクティブな決定事項

### 設計上の決定

1. **集約の設計方針**

   - チーム集約と課題集約の 2 つの集約に分割
   - チーム集約内に参加者を子エンティティとして含める
   - 集約間の参照は ID のみを使用

2. **値オブジェクトの実装方針**

   - 不変性を持つクラスとして実装
   - ファクトリメソッドでバリデーションを行い、Result 型で結果を返す
   - 等価性比較のための equals メソッドを実装

3. **リポジトリの実装方針**

   - インターフェースをドメイン層で定義、実装はインフラストラクチャ層で提供
   - トランザクション管理を考慮した設計
   - モックリポジトリを使用したテスト実装

4. **ドメインイベントの実装方針**
   - ドメインイベント基盤を `domain/event` フォルダに配置
   - 各集約に関連するイベントは、それぞれの集約のフォルダ内の `events` サブフォルダに配置
   - イベントハンドラーはアプリケーション層に配置
   - 同期的なイベント処理を採用（現在のプロジェクト規模では十分）

5. **APIエンドポイントの設計方針**
   - RESTfulなAPIデザインの原則に従う
   - 進捗ステータスごとに個別のエンドポイントを作成（例：`/tasks/:id/in-progress`）
   - URLパスに英語表記を使用し、内部で日本語の進捗ステータスにマッピング

### 技術的な決定

- Result 型を用いたエラーハンドリング
- ドメイン層は単体テストで高いカバレッジを確保
- 集約のサイズを適切に保つ
- 同期的なイベント処理を採用（シンプルさと即時整合性を重視）

## 現在の課題と懸念事項

1. **Nominal Typing**

   - TypeScript の構造的型システムでは、同じプロパティを持つ型が等価になってしまう
   - ブランド型や独自の型ガードを使用した名目的型付けの実装方法の検討

2. **集約サイズとクエリ最適化**

   - チーム集約が大きくなる可能性がある
   - 参加者単独の情報を取得するクエリが複雑になる可能性
   - クエリサービスを活用して読み取り操作を最適化する必要がある

3. **イベント処理のエラーハンドリング**

   - イベントハンドラ内でのエラーが、元の操作に影響しないようにする
   - エラーが発生した場合の適切なログ記録と通知

4. **既存ユースケースの更新**

   - Task エンティティの拡張に伴い、既存のユースケースを更新する必要がある
   - タスク完了状態変更ユースケースは進捗ステータス更新ユースケースに置き換える必要がある
   - UpdateTaskProgressUseCaseの実装計画と考慮点：
     - **リクエスト者IDの扱いの見直し**: タスクの所有者IDを自動的に使用する方式への変更を検討
     - **進捗ステータス文字列と値オブジェクトのマッピング改善**: 英語表記と日本語表記のマッピングの明確化
     - **コントローラー実装**: 進捗ステータスごとに個別のエンドポイントを作成する方式の採用
     - **既存のSetTaskDoneControllerとの統合**: 移行期間中は両方を維持し、後で`/tasks/:id/done`を非推奨にすることを検討

5. **既存ユースケースの最適化**
   - 既存のユースケースの効率化と改善
   - エラーハンドリングの強化
